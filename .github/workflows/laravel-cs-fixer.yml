name: PHP Coding Standards Fixer

on:
  workflow_call:

concurrency:
  group: cs-fixer-${{ github.ref }}
  cancel-in-progress: true

jobs:
  php-cs-fixer:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}

      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: |
            vendor
            ~/.cache/composer
          key: composer-${{ hashFiles('composer.lock') }}
          restore-keys: |
            composer-

      - name: Validate composer.json and composer.lock
        run: composer validate --no-check-all --strict

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress --no-suggest --no-interaction

      - name: Run Laravel Pint
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}
          CHANGED=$(git diff --name-only --diff-filter=ACMR ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} -- '*.php')

          if [ -n "$CHANGED" ]; then
            echo "Running Pint on changed files:"
            echo "$CHANGED"

            # Filter out any files that no longer exist
            EXISTING_FILES=""
            for file in $CHANGED; do
              if [ -f "$file" ]; then
                EXISTING_FILES="$EXISTING_FILES $file"
              fi
            done

            if [ -n "$EXISTING_FILES" ]; then
              vendor/bin/pint $EXISTING_FILES
            else
              echo "No existing PHP files to run Pint on."
            fi
          else
            echo "No PHP files changed."
          fi

      - name: Commit changes
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "Fix PHP coding style (Pint)"
          branch: ${{ github.head_ref }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}