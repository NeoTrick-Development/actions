name: Bun Deploy

on:
  workflow_call:
    secrets:
      deploy_host:
        required: true
      deploy_key:
        required: true
      deploy_user:
        required: true
      deploy_path:
        required: true
      deploy_env:
        required: true
      deploy_port:
        required: false
      pm2_port:
        required: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      NODE_OPTIONS: "--max_old_space_size=1024"
      NEXT_TELEMETRY_DISABLED: "1"
      REPO_NAME: ${{ github.event.repository.name }}
      PM2_CONFIG_PATH: "/var/www/configs"

    steps:
      - name: Checkout PM2 template repo
        uses: actions/checkout@v4
        with:
          repository: NeoTrick-Development/actions
          path: pm2-template

      - name: Generate PM2 config file
        run: |
          sed "s/{{APP_NAME}}/${{ env.REPO_NAME }}/g; s/{{APP_PORT}}/${{ secrets.pm2_port }}/g; s/{{APP_TYPE}}/bun/g; s#{{APP_PATH}}#${{ secrets.deploy_path }}#g" pm2-template/configs/bun.template.js > ${{ env.REPO_NAME }}.config.js

      - name: Upload PM2 config file
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.deploy_host }}
          username: ${{ secrets.deploy_user }}
          key: ${{ secrets.deploy_key }}
          port: ${{ secrets.deploy_port || '22' }}
          source: "${{ env.REPO_NAME }}.config.js"
          target: "${{ env.PM2_CONFIG_PATH }}"
          debug: true

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Restore node_modules cache
        uses: actions/cache@v4
        id: node-modules-cache
        with:
          path: node_modules
          key: ${{ runner.os }}-modules-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-modules-

      - name: Install dependencies (with cache optimization)
        run: |
          if [ -d "node_modules" ]; then
            echo "Using cached node_modules"
          else
            echo "Installing dependencies..."
            if [ "${{github.ref_name}}" = "develop" ]; then
              npm install --prefer-offline --no-audit --progress=false
            else
              npm install --omit=dev --prefer-offline --no-audit --progress=false
            fi
          fi

      - name: Create .env file from variable
        run: |
          echo "Creating .env file from variable..."
          echo "${{ secrets.deploy_env }}" > .env
          echo ".env file created."

      - name: Build Next.js (no lint)
        run: |
          NEXT_VERSION=$(npx next --version)
          MAJOR=$(echo $NEXT_VERSION | cut -d. -f1)

          if [ "$MAJOR" -lt 13 ]; then
            npm run build -- --no-lint
          else
            npm run build
          fi

      - name: Upload build files
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.deploy_host }}
          username: ${{ secrets.deploy_user }}
          key: ${{ secrets.deploy_key }}
          port: ${{ secrets.deploy_port || '22' }}
          source: ".next,package.json,public,next.config.mjs"
          target: ${{ secrets.deploy_path }}

      - name: Install Bun + Restart PM2 process
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.deploy_host }}
          username: ${{ secrets.deploy_user }}
          key: ${{ secrets.deploy_key }}
          port: ${{ secrets.deploy_port || '22' }}
          script: |
            # Navigate to the deployment directory
            cd ${{ secrets.deploy_path }}

            # Install production dependencies
            if [ "${{github.ref_name}}" = "develop" ]; then
              npm install --prefer-offline --no-audit --progress=false
            else
              npm install --omit=dev --prefer-offline --no-audit --progress=false
            fi

            # Restart or start the PM2 process
            pm2 reload ${{ env.PM2_CONFIG_PATH }}/${{ env.REPO_NAME }}.config.js || pm2 start ${{ env.PM2_CONFIG_PATH }}/${{ env.REPO_NAME }}.config.js
            pm2 save
